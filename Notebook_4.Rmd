---
title: "Notebook 4: Modeling Stream Biogeochemistry"
author: "your name"
date: "July 12, 2022"
output: html_notebook
---

```{r include=FALSE}
library(ggplot2)
library(dplyr)
library(lubridate)
library(scales)
library(GGally)
```

```{r echo=FALSE, message=FALSE, warning= FALSE}

#Multiplot function for GGally
my_fn <- function(data,mapping, method="loess",...){
  p <- ggplot(data = data, mapping = mapping) +
    geom_point() +
    geom_smooth(method=method, ...)
  p
}

#Loading the data and making some internal arrangement
hjs <- read.csv("220621_fho_hjandrews.csv")
hjs$dt <- as.Date(hjs$dt, origin = "1899-12-30", format = "%Y-%m-%d")
hjs$ws.f <- factor(hjs$ws.f,levels = c("Old-growth","Logged"))
hjs$ssn <- factor(hjs$ssn,levels = c("Fall","Winter","Spring","Summer"))
hjm <- dplyr::filter(hjs,wy>1983)
```

# Fundamentals of Hydrology: Modeling stream biogeochemistry

## Introduction

### Stream Biogeochemistry

**Question**: Explain how the water and carbon cycle are interconnected in streams and rivers?

**Question**: Describe the main forms in which carbon moves in streams and rivers.

Today, we are going to explore bio-geochemical data. These data span several decades and are part of a Long Term Ecological Research Forest in Oregon. The [H.J.Andrews LTER](https://andrewsforest.oregonstate.edu/) is located in the Oregon Cascades. But before looking at these data, we need to load some packages that we installed in the previous session

We will use the same data set analyzed in the stream flow section.


Our target variable for this analysis will be Dissolved Organic Carbon (DOC), let's take a look at the sampling conditions as related to discharge, suspended sediments, and dissolved silica (non-reactive tracer).

#### Dissolved Organic Carbon Samples and Discharge

```{r  echo=FALSE, message=FALSE, warning = FALSE}
doc_uq_ts <- ggplot(hjm,aes(x=as.Date(dt),y=uq.cm, color = ws.f))+
  geom_line()+
  geom_point(data=dplyr::filter(hjs,is.na(hjs$doc.mg_l)==FALSE),aes(x=as.Date(dt),y=uq.cm))+
  xlab("Water year")+
  ylab("Unit discharge (cm)")+
  scale_color_manual(values = c("#00BFC4","#F8766D"), name = "Forest type")+
  facet_wrap(~ws.f)
doc_uq_ts
```

#### Dissolved Organic Carbon sampling and Total Suspended Solids

```{r  echo=FALSE, message=FALSE, warning = FALSE}
doc_tss <- ggplot(hjm,aes(x=as.Date(dt),y=sed.mg_l, color = ws.f, fill = ws.f))+
  geom_line()+
  geom_point(data=dplyr::filter(hjs,is.na(hjs$doc.mg_l)==FALSE),aes(x=as.Date(dt),y=sed.mg_l))+
  scale_color_manual(values = c("#00BFC4","#F8766D"), name = "Forest type")+
  scale_fill_manual(values = c("#00BFC4","#F8766D"), name = "Forest type")+
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x)))+
  xlab("Water year")+
  ylab(expression(paste("Suspended Sediments (mg",l^{-1}, ")")))+
  facet_wrap(~ws.f)
doc_tss
```

#### Dissolved Organic Carbon sampling and Dissolved Silica


```{r  echo=FALSE, message=FALSE, warning = FALSE}
doc_slc <- ggplot(hjm,aes(x=as.Date(dt),y=slc.mg_l, color = ws.f, fill = ws.f))+
  geom_line()+
  geom_point(data=dplyr::filter(hjs,is.na(hjs$doc.mg_l)==FALSE),aes(x=as.Date(dt),y=slc.mg_l))+
  scale_color_manual(values = c("#00BFC4","#F8766D"), name = "Forest type")+
  scale_fill_manual(values = c("#00BFC4","#F8766D"), name = "Forest type")+
  xlab("Water year")+
  ylab(expression(paste("Dissolved Silica (mg",l^{-1}, ")")))+
  facet_wrap(~ws.f)
doc_slc
```

#### Dissolved Organic Carbon sampling and Dissolved Organic Nitrogen

```{r  echo=FALSE, message=FALSE, warning = FALSE}
doc_don <- ggplot(hjm,aes(x=as.Date(dt),y=don.mg_l, color = ws.f, fill = ws.f))+
  geom_line()+
  geom_point(data=dplyr::filter(hjs,is.na(hjs$doc.mg_l)==FALSE),aes(x=as.Date(dt),y=don.mg_l))+
  scale_color_manual(values = c("#00BFC4","#F8766D"), name = "Forest type")+
  scale_fill_manual(values = c("#00BFC4","#F8766D"), name = "Forest type")+
  xlab("Water year")+
  ylab(expression(paste("Dissolved Organic Nitrogen (mg",l^{-1}, ")")))+
  facet_wrap(~ws.f)
doc_don
```
*To do:* Add captions to the figures above and describe how representative are the doc samples in terms of the variation of discharge, sediment transport, dissolved silica, and dissolved organic nitrogen.

### Predicting Dissolved Organic Carbon in Headwater streams

Our selection of discharge, sediment transport, dissolved silica, and dissolved organic nitrogen in the plots above is not random. All of this variables affect the concentrations of DOC directly or indirectly. 

*To do*: Look for examples of relationships between Q, TSS, DSi, and DON with DOC in headwater streams in the literature. Write a short paragraph (no more than 4 sentences about each of the relationships-please include the bibliographic reference)

Let's now explore these relationships in our dataset:

```{r echo=FALSE, message=FALSE, warning = FALSE, results='hide', fig.keep='all'}
require(GGally)

p_dat <- dplyr::select(hjm,ws.f,dt,ssn,log.uq,log.sed.mg_l,log.slc.mg_l,log.don.mg_l,log.doc.mg_l)

p <- ggpairs(p_dat, columns = 4:8, ggplot2::aes(colour = ws.f, alpha = 0.6),
             lower = list(continuous = wrap(my_fn, method="lm", se=FALSE)))
for(i in 1:p$nrow){
  for(j in 1:p$ncol){
    p[i,j] <- p[i,j]+
      scale_fill_manual(values= c("#00BFC4","#F8766D"))+
      scale_color_manual(values= c("#00BFC4","#F8766D"))
  }
}
p
```





In this dataset, Total Suspended Solids (TSS) is represented by the variable "sed.mg_l" in which mg_l is the concentration unit (miligrams per litter). Let's start with a quick look of the time series:

### Suspended sediments over time

```{r echo=FALSE, message=FALSE, warning = FALSE}
dat_tss_fig <- ggplot(hjs, aes(y=sed.mg_l, x= dt, color = ws.f, fill = ws.f))+
  geom_line(alpha=0.5)+
  geom_point(alpha = 0.5)+
  # geom_smooth(span = 0.35)+
  scale_x_date()+
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x)))+ #the function trans_breaks comes with the package scales
  xlab("Water year")+
  ylab(expression(paste("Suspended Sediments (mg",l^{-1}, ")")))+
  scale_color_manual(values = c("#00BFC4","#F8766D"))+
  scale_fill_manual(values = c("#00BFC4","#F8766D"))+
  facet_wrap(~ws.f)+
  theme_fg
dat_tss_fig
```

*To do*: Add a caption to the figure and describe the changes observed over time.

### Suspended sediment concentrations along the hydrological year (Oct 1 - Sept 30)

```{r echo=FALSE,message=FALSE, warning = FALSE}
day_tss_fig <- ggplot(hjs, aes(y=sed.mg_l, x= wd, color = ws.f, fill = ws.f))+
  geom_line(alpha=0.5)+
  # geom_point(alpha = 0.5)+
  geom_smooth(span = 0.35)+
  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x)))+
  xlab("Water day")+
  ylab(expression(paste("Suspended Sediments (mg",l^{-1}, ")")))+
  scale_color_manual(values = c("#00BFC4","#F8766D"))+
  scale_fill_manual(values = c("#00BFC4","#F8766D"))+
  facet_wrap(~ws.f)+
  theme_fg
day_tss_fig
```

*To do*: Add a caption to the figure and describe the changes observed over time.

### Distribution of TSS concentrations in and Old-growth and logged watershed in the Oregon Cascades

```{r echo=FALSE,message=FALSE, warning = FALSE}
hist_tss_fig <- ggplot(hjs, aes(x=sed.mg_l, color = ws.f, fill = ws.f))+
  # geom_histogram(alpha = 0.5)+
  geom_density(alpha = 0.5)+
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x)))+
  # ylab("Frequency")+
  ylab("Estimated kernel density")+
  xlab(expression(paste("Suspended Sediments (mg",l^{-1}, ")")))+
  scale_color_manual(values = c("#00BFC4","#F8766D"))+
  scale_fill_manual(values = c("#00BFC4","#F8766D"))+
  # facet_wrap(~ws.f)+
  theme_fg
hist_tss_fig
```

*To do*: add a caption to the figure and compare the density distribution of TSS concentrations between watersheds.

### Seasonal changes in the distribution of TSS concentrations in and Old-growth and logged watershed in the Oregon Cascades

```{r echo=FALSE, message=FALSE, warning = FALSE}
ssn_tss_fig <- ggplot(hjs, aes(x=sed.mg_l, color = ssn, fill = ssn))+
  # geom_histogram(alpha = 0.5)+
  geom_density(alpha = 0.5)+
  scale_x_log10()+
  ylab("Estimated kernel density")+
  xlab(expression(paste("Suspended Sediments (mg",l^{-1}, ")")))+
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x)))+
  facet_wrap(~ws.f)+
  theme_fg
ssn_tss_fig
```

Let's compare both watersheds season by season

```{r echo=FALSE, message=FALSE, warning = FALSE}
ssn_tss_fig <- ggplot(hjs, aes(x=sed.mg_l, color = ws.f, fill = ws.f))+
  # geom_histogram(alpha = 0.5)+
  geom_density(alpha = 0.5, size = 0.75)+
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x)))+
  ylab("Estimated Kernel Density")+
  xlab(expression(paste("Suspended Sediments (mg",l^{-1}, ")")))+
  scale_color_manual(values = c("#00BFC4","#F8766D"))+
  scale_fill_manual(values = c("#00BFC4","#F8766D"))+
  facet_wrap(~ssn)+
  theme_fg
ssn_tss_fig
```

*To do*: add a caption to the figure and compare the density distribution of TSS concentrations between watersheds.

### Temporal evolution in the Suspended sediment load in heawater streams in the Oregon Cascades

Let's first take a look at the TSS distributions in 5-year increments:

```{r echo=FALSE, message=FALSE, warning = FALSE}
prd_tss_fig <- ggplot(hjs, aes(x=sed.mg_l, color = ws.f, fill = ws.f))+
  # geom_histogram(alpha = 0.5)+
  geom_density(alpha = 0.5, size = 0.75)+
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x)))+
  ylab("Estimated Kernel Density")+
  xlab(expression(paste("Suspended Sediments (mg",l^{-1}, ")")))+
  scale_color_manual(values = c("#00BFC4","#F8766D"))+
  scale_fill_manual(values = c("#00BFC4","#F8766D"))+
  facet_wrap(~prd,ncol = 4)+
  theme_fg+
  theme(legend.position = c(0.08,0.9))
prd_tss_fig
```

Let's take a similar look at discharge data:

```{r echo=FALSE, message=FALSE, warning = FALSE}
prd_uqm_fig <- ggplot(hjs, aes(x=uq.cm, color = ws.f, fill = ws.f))+
  # geom_histogram(alpha = 0.5)+
  geom_density(alpha = 0.65, size = 0.75)+
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x)))+
  ylab("Estimated Kernel Density")+
  xlab("Unit discharge (cm)")+
  scale_color_manual(values = c("#00BFC4","#F8766D"))+
  scale_fill_manual(values = c("#00BFC4","#F8766D"))+
  facet_wrap(~prd,ncol = 4)+
  theme_fg
prd_uqm_fig
```

Let's now calculate sediment load:

```{r}
 hjs$sed_kg_ha <- (hjs$uq.cm * hjs$sed.mg_l)/10
```

Finally, let's take a look at the temporal evolution of the sediment load:

```{r echo=FALSE, message=FALSE, warning = FALSE}
prd_sld_fig <- ggplot(hjs, aes(x=sed_kg_ha, color = ws.f, fill = ws.f))+
  geom_density(alpha = 0.65, size = 0.75)+
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x)))+
  ylab("Estimated Kernel Density")+
  xlab(expression(paste("Sediment load (kg", ha^{-1}, ")")))+
  scale_color_manual(values = c("#00BFC4","#F8766D"))+
  scale_fill_manual(values = c("#00BFC4","#F8766D"))+
  facet_wrap(~prd,ncol = 4)+
  theme_fg
prd_sld_fig
```

*To do*: add a caption to the figure and compare the density distribution of Sediment loads between watersheds and across time periods.
